---
- Research goal:Gather information related to customersÃfÆ'Ã,Â¢ÃfÂ¢Ã¢â,¬Å¡Ã,Â¬ÃfÂ¢Ã¢â,¬Å¾Ã,Â¢
  dynamic product return behavior and its impact on future purchases. Data source:relational
---

#"products"contains 655,557 records of product details, and this is a dataset cleaned by excel.Cleaning steps are listed as follows:
1.Keep the variables that are relevant for the research goal
2.Clean the sku_description variable
clean the extra characteristics like #,=+,=-,' 
Select the left three letters and convert into upper case
Create a new column named brand. If the left three letters of sku_description column are "REI", then 1, else 0

#"pg_detail_recs_03"contains 442,6841 records of order details

##Log in data
```{r}
#load data from SAS&csv file.I saved the file to the local drive for privacy
library(haven)
products <- read.csv("//netid.washington.edu/csde/other/desktop/sym2016/Desktop/pg_sku_recs_cleaned.csv")
pg_detail_recs_03 <- read_sas("C:/Users/sym2016/Downloads/pg_detail_recs_03.sas7bdat", 
    NULL)

#check if I have fully loaded the data
nrow(pg_detail_recs_03)
nrow(products)

#Raw data overview
str(pg_detail_recs_03)
str(products)
```


##Data Preparation
```{r}
#Keep the relevant columns in pg_detail_recs_03
orders = subset(pg_detail_recs_03, select = c(1,3,6,7,9,10,20,21) )
View(orders)

#check the data type and transform
str(orders)

#drop the records where sk_item_id is -3
orders1=subset(orders, sk_item_id!=-3)
```

#load sql package and use sql to merge data
```{r}
install.packages("sqldf")
library(sqldf)

```

```{r}
orders2<-sqldf("
SELECT customer_id,
       sk_transaction_id,
       trans_type_id,
       d_date,
       channel_id,
       t1.sk_item_id,
       current_corporate_price-weighted_avg_cost AS profit,
       t2.brand
FROM orders1 AS t1
LEFT JOIN products AS t2 ON t1.sk_item_id=t2.sk_item_id
                   ")
```


```{r}
#drop the records where brand is null, this means that there are no records in products to match this product
orders3<- orders2[-which(is.na(orders_test$brand)), ]
View(orders3)

#impute the average profit of REI brands items and non-REI brands items
avg_rei<-sqldf("select avg(profit)
FROM orders_full
WHERE brand=1 ")
list(avg_rei)

avg_other<-sqldf("select avg(profit)
FROM orders_full
                 WHERE brand=0 ")
list(avg_other)
```

#use the imputed mean to fill the missing value in profit column according to products' brand
```{r}
orders3$profit[is.na(orders3$profit)] <- 0
orders3$profit[orders3$profit == 0 & orders3$brand == 1] <- 21.955
orders3$profit[orders3$profit == 0 & orders3$brand == 0] <- 14.697
```

#drop the records where profit<0
```{r}

orders4=subset(orders3, profit>0)
summary.data.frame(orders4)
```

#Only keep the records with customers who have return behaviors
```{r}
orders5<-sqldf("
SELECT *
FROM orders4
WHERE orders4.customer_id IN(
  SELECT DISTINCT customer_id
  FROM orders4 WHERE trans_type_id='RETN'
                  )
               ")
```

